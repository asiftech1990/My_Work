Authentication

Here is the flow
1- Setup aws-sso, then integrate with AD connector which proxy to your on-prem LDAP.
aws configure sso

SSO session name: company-sso
SSO start URL: https://yourcompany.awsapps.com/start
SSO region: us-east-1
SSO account: <your-account-id>
SSO role name: EKS-Admin (or EKS-Dev, etc.)


2- Create IAM permission set in IAM Identity Center â€“ (EKS-Admin, EKS-ReadOnly, EKS-Dev)
3- Update aws-auth  configmap with permission set

kubectl get configmap aws-auth -n kube-system -o yaml


apiVersion: v1
kind: ConfigMap
metadata:
  name: aws-auth
  namespace: kube-system
data:
  mapRoles: |
    - rolearn: arn:aws:iam::123456789012:role/EKS-AdminRole
      username: eks-admin
      groups:
        - system:masters
    - rolearn: arn:aws:iam::123456789012:role/EKS-DevRole
      username: eks-dev
      groups:
        - dev-team
  mapUsers: |
    - userarn: arn:aws:iam::123456789012:user/alice
      username: alice
      groups:
        - system:masters


4- Create EKS Role for view/edit/admin


kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  namespace: dev
  name: dev-namespace-role
rules:
- apiGroups: [""]
  resources: ["pods", "services", "configmaps"]
  verbs: ["get", "list", "watch", "create", "update", "delete"]


5- Create rolebinding and map EKS Role to IAM Permission set users available in aws-auth

# Kubernetes RBAC
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: dev
  name: dev-namespace-role
rules:
- apiGroups: [""]
  resources: ["pods", "services"]
  verbs: ["get", "list", "create", "delete"]

kind: RoleBinding
metadata:
  name: dev-namespace-binding
  namespace: dev
subjects:
- kind: Group
  name: dev-team        # This matches aws-auth group
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: Role
  name: dev-namespace-role
  apiGroup: rbac.authorization.k8s.io

Installation

=============================================

Little more about authentication

- When we create namespace, it automatically creates IAM Role for that namespace, namespace role and add this IAM Role and attach necessary permission like DescribeCluster and add it in aws_auth CM, then create a rolebinding for Kubernetes role and IAM role.


================================================

1- AWS EBS CSI Drive Pluging for Dynaic provisioning.
2- OpenID Connect (OIDC) provider URL  = https://www.youtube.com/watch?v=otmLHWW3Tos&t=132s
3- Cloud Trail - Event History
